<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Image to PDF Converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
body{background:#f2f2f2}
.card{max-width:800px;margin:30px auto;box-shadow:0 0 15px rgba(0,0,0,.2)}
.preview img{height:100px;object-fit:contain;border:1px solid #ccc;padding:5px;background:#fff}
.preview{cursor:grab}
</style>
</head>

<body>

<div class="card p-4">
<h4 class="text-center mb-3">ðŸ“„ Smart Image â†’ A4 PDF Converter</h4>

<input type="file" id="images" class="form-control mb-3" multiple accept="image/*">

<label class="form-label">Compression Level</label>
<select id="quality" class="form-select mb-3">
  <option value="0.4">Very High (Small size)</option>
  <option value="0.6" selected>Medium</option>
  <option value="0.8">Low (Better quality)</option>
</select>

<div class="mb-3">
  <label class="form-label">Preview & Reorder (Drag)</label>
  <div id="preview" class="preview d-flex gap-2 flex-wrap"></div>
</div>

<button class="btn btn-success w-100" onclick="generatePDF()">Convert to PDF</button>
</div>

<script>
let imageFiles = [];

document.getElementById("images").addEventListener("change", e=>{
  imageFiles = [...e.target.files];
  renderPreview();
});

function renderPreview(){
  const box = document.getElementById("preview");
  box.innerHTML = "";
  imageFiles.forEach((file,i)=>{
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.dataset.index = i;
    box.appendChild(img);
  });

  new Sortable(box,{
    animation:150,
    onEnd:e=>{
      const moved = imageFiles.splice(e.oldIndex,1)[0];
      imageFiles.splice(e.newIndex,0,moved);
    }
  });
}

// ðŸ”¥ REAL COMPRESSION FUNCTION
function compressImage(file, quality){
  return new Promise(resolve=>{
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff"; // white background
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0);

      canvas.toBlob(blob=>{
        resolve(blob);
      },"image/jpeg",quality);
    };
    img.src = URL.createObjectURL(file);
  });
}

async function generatePDF(){
  if(imageFiles.length===0){
    alert("Please select images");
    return;
  }

  const quality = parseFloat(document.getElementById("quality").value);
  const pdfDoc = await PDFLib.PDFDocument.create();

  const A4_W = 595;
  const A4_H = 842;

  for(const file of imageFiles){
    const compressedBlob = await compressImage(file,quality);
    const bytes = await compressedBlob.arrayBuffer();
    const img = await pdfDoc.embedJpg(bytes);

    const page = pdfDoc.addPage([A4_W,A4_H]);

    const scale = Math.min(A4_W/img.width,A4_H/img.height);
    const w = img.width*scale;
    const h = img.height*scale;

    page.drawImage(img,{
      x:(A4_W-w)/2,
      y:(A4_H-h)/2,
      width:w,
      height:h
    });
  }

  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes],{type:"application/pdf"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "Smart_Image_to_PDF.pdf";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
